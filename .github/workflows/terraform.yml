name: "Terraform CI/CD"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  TF_VAR_gh_pat: ${{ secrets.GH_PAT }}
  TF_VAR_mail_username: ${{ secrets.MAIL_USERNAME }}
  TF_VAR_mail_password: ${{ secrets.MAIL_PASSWORD }}
  TF_VAR_mail_from: ${{ secrets.MAIL_FROM }}
  TF_VAR_mail_port: ${{ secrets.MAIL_PORT }}
  TF_VAR_mail_server: ${{ secrets.MAIL_SERVER }}
  TF_VAR_access_token_expire_minutes: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
  TF_VAR_secret_key: ${{ secrets.SECRET_KEY }}
  TF_VAR_algorithm: ${{ secrets.ALGORITHM }}
  TF_VAR_amadeus_api_key: ${{ secrets.AMADEUS_API_KEY }}
  TF_VAR_amadeus_api_secret: ${{ secrets.AMADEUS_API_SECRET }}
  TF_VAR_amadeus_base_url: ${{ secrets.AMADEUS_BASE_URL }}
  TF_VAR_database_url: ${{ secrets.DATABASE_URL }}
  TF_VAR_pesapal_consumer_key: ${{ secrets.PESAPAL_CONSUMER_KEY }}
  TF_VAR_pesapal_consumer_secret: ${{ secrets.PESAPAL_CONSUMER_SECRET }}
  TF_VAR_pesapal_base_url: ${{ secrets.PESAPAL_BASE_URL }}
  TF_VAR_pesapal_ipn_id: ${{ secrets.PESAPAL_IPN_ID }}
  TF_VAR_cloudinary_url: ${{ secrets.CLOUDINARY_URL }}
  TF_VAR_redis_url: ${{ secrets.REDIS_URL }}
  TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
  TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  TF_VAR_google_redirect_uri: ${{ secrets.GOOGLE_REDIRECT_URI }}
  TF_VAR_cors_origins: ${{ secrets.CORS_ORIGINS }}
  TF_VAR_frontend_url: ${{ secrets.FRONTEND_URL }}
  TF_VAR_environment: ${{ secrets.ENVIRONMENT }}
  TF_VAR_key_pair_name: ${{ secrets.KEY_PAIR_NAME }}

jobs:
  terraform-plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform Init
        run: terraform -chdir=terraform init
        
      - name: Terraform Validate
        run: terraform -chdir=terraform validate
        
      - name: Terraform Plan
        run: terraform -chdir=terraform plan -no-color
        continue-on-error: true

  deploy-infrastructure:
    name: "Deploy Infrastructure"
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform Init
        run: terraform -chdir=terraform init
        
      - name: Terraform Validate
        run: terraform -chdir=terraform validate
        
      - name: Terraform Plan
        run: terraform -chdir=terraform plan -out=tfplan
        
      - name: Terraform Apply
        run: terraform -chdir=terraform apply -auto-approve tfplan

      - name: Get EC2 IP
        id: get_ip
        run: echo "ec2_public_ip=$(terraform -chdir=terraform output -raw ec2_public_ip)" >> $GITHUB_OUTPUT
    outputs:
      ec2_public_ip: ${{ steps.get_ip.outputs.ec2_public_ip }}

  deploy-app:
    name: "Deploy Application"
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.deploy-infrastructure.outputs.ec2_public_ip }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/aero_bound_ventures
            git pull origin main
            cd backend
            docker-compose down
            docker-compose up -d --build
